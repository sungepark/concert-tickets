<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Concert Tickets - Find Your Next Show</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header>
    <nav>
      <a href="/" class="logo">ConcertTix</a>
      <div class="nav-links">
        <a href="/">Events</a>
        <a href="/cart" class="cart-link">
          Cart <span class="cart-count" id="cart-count">0</span>
        </a>
        <div id="auth-nav"></div>
      </div>
    </nav>
  </header>

  <main>
    <h1>Upcoming Concerts</h1>
    <p class="subtitle">Discover and book tickets for the hottest shows in town</p>

    <div class="events-grid" id="events-grid">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    // Get cart count from cookie
    function getCartCount() {
      const match = document.cookie.match(/cartCount=(\d+)/);
      return match ? parseInt(match[1]) : 0;
    }

    // Update cart count display
    function updateCartCount() {
      document.getElementById('cart-count').textContent = getCartCount();
    }

    // Format date nicely
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    // Format price
    function formatPrice(price) {
      return '$' + price.toFixed(2);
    }

    // Get current user
    async function getCurrentUser() {
      try {
        const response = await fetch('/api/user');
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.error('Error fetching user:', error);
      }
      return null;
    }

    // Update navigation based on user state
    async function updateNavigation() {
      const authNav = document.getElementById('auth-nav');
      const user = await getCurrentUser();

      if (user) {
        authNav.innerHTML = `
          <div class="user-menu">
            <span class="user-name">Welcome, ${user.name}</span>
            <a href="#" onclick="logout(); return false;">Logout</a>
          </div>
        `;
      } else {
        authNav.innerHTML = `
          <a href="/login">Login</a>
          <a href="/register">Register</a>
        `;
      }
    }

    // Logout function
    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Load and display events
    async function loadEvents() {
      try {
        const response = await fetch('/api/events');
        const events = await response.json();

        const grid = document.getElementById('events-grid');

        if (events.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <h2>No Events Available</h2>
              <p>Check back soon for upcoming concerts!</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = events.map(event => `
          <div class="event-card ${event.available_tickets === 0 ? 'sold-out' : ''}" onclick="window.location.href='/event/${event.id}'">
            ${event.available_tickets === 0 ? '<div class="sold-out-badge">SOLD OUT</div>' : ''}
            <img src="${event.image_url}" alt="${event.artist_name}">
            <div class="event-card-content">
              <h3>${event.artist_name}</h3>
              <div class="venue">${event.venue_name}</div>
              <div class="date">${formatDate(event.event_date)}</div>
              <div class="price">${formatPrice(event.ticket_price)}</div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('events-grid').innerHTML = `
          <div class="empty-state">
            <h2>Error Loading Events</h2>
            <p>Please try again later.</p>
          </div>
        `;
      }
    }

    // Initialize
    updateCartCount();
    updateNavigation();
    loadEvents();
  </script>
</body>
</html>
