<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart Summary - ConcertTix</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .summary-page-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 3rem;
    }

    @media (max-width: 900px) {
      .summary-page-container {
        grid-template-columns: 1fr;
      }
    }

    .summary-items {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .summary-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1.25rem;
      display: grid;
      grid-template-columns: 80px 1fr auto;
      gap: 1rem;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 600px) {
      .summary-item {
        grid-template-columns: 1fr;
        text-align: center;
      }
    }

    .summary-item img {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }

    .summary-item-info h3 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .summary-item-info .venue {
      color: #e94560;
      font-size: 0.85rem;
    }

    .summary-item-info .date {
      color: #a0a0a0;
      font-size: 0.8rem;
    }

    .summary-item-price {
      text-align: right;
    }

    .summary-item-price .qty {
      font-size: 0.85rem;
      color: #a0a0a0;
      margin-bottom: 0.25rem;
    }

    .summary-item-price .price {
      font-size: 1.1rem;
      font-weight: bold;
      color: #4ecca3;
    }

    .cost-breakdown {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .cost-breakdown h2 {
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
    }

    .cost-line {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.95rem;
    }

    .cost-line .label {
      color: #a0a0a0;
    }

    .cost-line .value {
      color: #fff;
    }

    .cost-line.subtotal {
      font-weight: 600;
    }

    .cost-line.subtotal .value {
      color: #4ecca3;
    }

    .cost-section-title {
      font-size: 0.85rem;
      color: #a0a0a0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cost-total {
      display: flex;
      justify-content: space-between;
      padding: 1.25rem 0;
      margin-top: 1rem;
      border-top: 2px solid rgba(255, 255, 255, 0.2);
      font-size: 1.5rem;
      font-weight: bold;
    }

    .cost-total .value {
      color: #4ecca3;
    }

    .action-buttons {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .items-header h2 {
      font-size: 1.25rem;
    }

    .items-header .item-count {
      color: #a0a0a0;
      font-size: 0.9rem;
    }

    .edit-cart-link {
      color: #e94560;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .edit-cart-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/" class="logo">ConcertTix</a>
      <div class="nav-links">
        <a href="/">Events</a>
        <a href="/cart" class="cart-link">
          Cart <span class="cart-count" id="cart-count">0</span>
        </a>
      </div>
    </nav>
  </header>

  <main>
    <a href="/cart" class="back-link">&larr; Back to Cart</a>
    <h1>Order Summary</h1>
    <p class="subtitle">Review your order details before checkout</p>

    <div id="summary-content">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const TAX_RATE = 0.08;
    const SERVICE_FEE_RATE = 0.10;
    const FACILITY_FEE_PER_TICKET = 2.50;
    const ORDER_PROCESSING_FEE = 3.99;

    function getCartCount() {
      const match = document.cookie.match(/cartCount=(\d+)/);
      return match ? parseInt(match[1]) : 0;
    }

    function updateCartCountDisplay() {
      document.getElementById('cart-count').textContent = getCartCount();
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function formatPrice(price) {
      return '$' + price.toFixed(2);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function loadSummary() {
      try {
        const response = await fetch('/api/cart');
        const cart = await response.json();

        const content = document.getElementById('summary-content');

        if (cart.items.length === 0) {
          content.innerHTML = `
            <div class="empty-state">
              <h2>Your Cart is Empty</h2>
              <p>Add some tickets to your cart to see the summary.</p>
              <a href="/" class="btn btn-primary">Browse Events</a>
            </div>
          `;
          return;
        }

        const itemsHtml = cart.items.map(item => `
          <div class="summary-item">
            <img src="${item.image_url}" alt="${item.artist_name}">
            <div class="summary-item-info">
              <h3>${item.artist_name}</h3>
              <div class="venue">${item.venue_name}</div>
              <div class="date">${formatDate(item.event_date)}</div>
            </div>
            <div class="summary-item-price">
              <div class="qty">${item.quantity} x ${formatPrice(item.ticket_price)}</div>
              <div class="price">${formatPrice(item.ticket_price * item.quantity)}</div>
            </div>
          </div>
        `).join('');

        const totalTickets = cart.items.reduce((sum, item) => sum + item.quantity, 0);
        const subtotal = cart.total;
        const serviceFee = subtotal * SERVICE_FEE_RATE;
        const facilityFee = totalTickets * FACILITY_FEE_PER_TICKET;
        const processingFee = ORDER_PROCESSING_FEE;
        const feesSubtotal = serviceFee + facilityFee + processingFee;
        const taxableAmount = subtotal + feesSubtotal;
        const tax = taxableAmount * TAX_RATE;
        const grandTotal = taxableAmount + tax;

        content.innerHTML = `
          <div class="summary-page-container">
            <div class="summary-items-section">
              <div class="items-header">
                <h2>Your Tickets</h2>
                <span class="item-count">${totalTickets} ticket${totalTickets !== 1 ? 's' : ''}</span>
              </div>
              <div class="summary-items">
                ${itemsHtml}
              </div>
              <div style="margin-top: 1rem;">
                <a href="/cart" class="edit-cart-link">Edit Cart</a>
              </div>
            </div>

            <div class="cost-breakdown">
              <h2>Cost Breakdown</h2>

              <div class="cost-line subtotal">
                <span class="label">Tickets (${totalTickets})</span>
                <span class="value">${formatPrice(subtotal)}</span>
              </div>

              <div class="cost-section-title">Fees</div>

              <div class="cost-line">
                <span class="label">Service Fee (${(SERVICE_FEE_RATE * 100).toFixed(0)}%)</span>
                <span class="value">${formatPrice(serviceFee)}</span>
              </div>

              <div class="cost-line">
                <span class="label">Facility Fee (${formatPrice(FACILITY_FEE_PER_TICKET)}/ticket)</span>
                <span class="value">${formatPrice(facilityFee)}</span>
              </div>

              <div class="cost-line">
                <span class="label">Order Processing</span>
                <span class="value">${formatPrice(processingFee)}</span>
              </div>

              <div class="cost-section-title">Taxes</div>

              <div class="cost-line">
                <span class="label">Sales Tax (${(TAX_RATE * 100).toFixed(0)}%)</span>
                <span class="value">${formatPrice(tax)}</span>
              </div>

              <div class="cost-total">
                <span>Total</span>
                <span class="value">${formatPrice(grandTotal)}</span>
              </div>

              <div class="action-buttons">
                <button class="btn btn-primary" onclick="placeOrder()">
                  Place Order
                </button>
                <a href="/cart" class="btn btn-secondary" style="text-align: center;">
                  Back to Cart
                </a>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading summary:', error);
        document.getElementById('summary-content').innerHTML = `
          <div class="empty-state">
            <h2>Error Loading Summary</h2>
            <p>Please try again later.</p>
            <a href="/cart" class="btn btn-primary">Back to Cart</a>
          </div>
        `;
      }
    }

    function placeOrder() {
      showToast('Order placement coming soon!');
    }

    updateCartCountDisplay();
    loadSummary();
  </script>
</body>
</html>
